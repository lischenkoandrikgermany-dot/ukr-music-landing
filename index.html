<script>
/* ===== UKR-Hits: Radio logic (использует CURATED_IDS) ===== */
(() => {
  // элементы
  const $ = s => document.querySelector(s);
  const panel = $('#gwPanel');
  const nowEl = $('#gwNow');
  const collapsedEl = $('#gwCollapsed');
  const playBtn = $('#gwPlay');
  const playLabel = $('#gwPlayLabel');
  const prevBtn = $('#gwPrev');
  const nextBtn = $('#gwNext');
  const shufBtn = $('#gwShuf');
  const openBtn = $('#gwOpen');
  const miniBtn = $('#gwMiniOpen');
  const closeBtn = $('#gwClose');
  const minBtn = $('#gwMin');

  // очередь — берем твой список
  let queue = Array.isArray(window.CURATED_IDS) ? window.CURATED_IDS.slice() : [];
  let shuffled = false;

  function shuffleInPlace(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

  // Состояние
  let player = null;
  let currentIndex = 0;
  let ready = false;

  // API callback
  window.onYouTubeIframeAPIReady = window.onYouTubeIframeAPIReady || function(){
    if(!queue.length) return;
    player = new YT.Player('gwPlayer', {
      width: '100%',
      height:'100%',
      videoId: queue[currentIndex],
      playerVars: {autoplay: 0, controls: 0, rel: 0, modestbranding: 1},
      events:{
        'onReady': (e)=>{ ready = true; updateTitle(); },
        'onStateChange': (e)=>{
          if(e.data === YT.PlayerState.ENDED){ next(); }
          if(e.data === YT.PlayerState.PLAYING){ playLabel.textContent='Pause'; }
          if(e.data === YT.PlayerState.PAUSED){ playLabel.textContent='Play'; }
        }
      }
    });
  };

  function updateTitle(){
    // минимально: показываем ID как fallback
    nowEl.textContent = 'Відтворення…';
    collapsedEl.textContent = 'Відтворення…';
    try{
      // пробуем получить название через getVideoData()
      const vd = player && player.getVideoData ? player.getVideoData() : null;
      const t = vd && vd.title ? vd.title : `https://youtu.be/${queue[currentIndex]}`;
      nowEl.textContent = t;
      collapsedEl.textContent = t;
    }catch{}
  }

  function openPanel(){ panel.classList.add('open'); panel.classList.remove('minimized'); }
  function closePanel(){ panel.classList.remove('open'); panel.classList.remove('minimized'); }
  function minimize(){ panel.classList.add('minimized'); panel.classList.add('open'); }

  function playPause(){
    if(!ready || !player) return;
    const st = player.getPlayerState();
    if(st === YT.PlayerState.PLAYING){ player.pauseVideo(); playLabel.textContent='Play'; }
    else { player.playVideo(); playLabel.textContent='Pause'; }
  }

  function load(i){
    if(!player || !ready) return;
    currentIndex = (i+queue.length)%queue.length;
    player.loadVideoById(queue[currentIndex]);
    updateTitle();
  }

  function prev(){ load(currentIndex-1); }
  function next(){ load(currentIndex+1); }

  // events
  openBtn.addEventListener('click', openPanel);
  if(miniBtn) miniBtn.addEventListener('click', openPanel);
  closeBtn.addEventListener('click', closePanel);
  minBtn.addEventListener('click', minimize);
  playBtn.addEventListener('click', playPause);
  prevBtn.addEventListener('click', prev);
  nextBtn.addEventListener('click', next);
  shufBtn.addEventListener('click', ()=>{
    shuffled = !shuffled;
    shufBtn.classList.toggle('active', shuffled);
    if(shuffled){
      const currentId = queue[currentIndex];
      shuffleInPlace(queue);
      // держим текущий трек на месте
      currentIndex = queue.indexOf(currentId);
    }else{
      // возвращаем исходный порядок
      queue = Array.isArray(window.CURATED_IDS) ? window.CURATED_IDS.slice() : queue;
      currentIndex = Math.max(0, queue.indexOf(player.getVideoData().video_id || queue[currentIndex]));
    }
  });

  // Если API уже загрузился раньше
  if(window.YT && window.YT.Player && !player){ window.onYouTubeIframeAPIReady(); }
})();
</script>
